/**
* cts
 * Declarative structural remapping for the web.
 *
 * @author Ted Benson <eob@csail.mit.edu>>
 * @copyright Ted Benson 2013
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://www.treesheets.org
 * @module cts
 * @version 0.5.0
 */
(function(){var e=this,t;typeof exports!="undefined"?t=exports:t=e.CTS={},t.VERSION="0.1.0",t.$=e.jQuery;var n=e._;!n&&typeof require!="undefined"&&(n=require("underscore"));var i=t.StateMachine={fsmInitialize:function(e,t,r){this._fsmCurrent=e,this._fsmArcs={},n.each(t,function(e){n.contains(this._fsmArcs,e.from)||(this._fsmArcs[e.from]={}),this._fsmArcs[e.from][e.to]=e.name},this)},fsmCurrentState:function(){return this._fsmCurrent},fsmCanTransition:function(e){return this._fsmArcs[this._fsmCurrent]&&this._fsmArcs[this._fsmCurrent][e]?!0:!1},fsmTransition:function(e){if(!this.fsmCanTransition)throw new Error("Can not make transition "+this._fsmCurrent+" -> "+e);var t=this._fsmCurrent,n=e,r=this._fsmArcs[t][n];this.trigger("FsmLeft:"+t),this._fsmCurrent=n,console.log(this,"Transitioning to",n),this.trigger("FsmEdge:"+r),this.trigger("FsmEntered:"+n)}},s=/\s+/,o=function(e,t,n,r){if(!n)return!0;if(typeof n=="object")for(var i in n)e[t].apply(e,[i,n[i]].concat(r));else{if(!s.test(n))return!0;var o=n.split(s);for(var u=0,a=o.length;u<a;u++)e[t].apply(e,[o[u]].concat(r))}},u=function(e,t,n){var r,i=-1,s=t.length;switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0]);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1]);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1],n[2]);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx,n)}},a=t.Events={on:function(e,t,r){if(!o(this,"on",e,[t,r])||!t)return this;if(n.isUndefined(this._events)||n.isNull(this._events))this._events={};var i=this._events[e]||(this._events[e]=[]);return i.push({callback:t,context:r,ctx:r||this}),this},once:function(e,t,r){if(!o(this,"once",e,[t,r])||!t)return this;var i=this,s=n.once(function(){i.off(e,s),t.apply(this,arguments)});return s._callback=t,this.on(e,s,r),this},off:function(e,t,r){var i,s,u,a,f,l,c,h;if(!this._events||!o(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events={},this;a=e?[e]:n.keys(this._events);for(f=0,l=a.length;f<l;f++){e=a[f],i=this._events[e];if(i){u=[];if(t||r)for(c=0,h=i.length;c<h;c++)s=i[c],(t&&t!==(s.callback._callback||s.callback)||r&&r!==s.context)&&u.push(s);this._events[e]=u}}return this},trigger:function(e){if(!this._events)return this;var t=[];arguments.length>1&&(t=arguments.slice(1,arguments.length));if(!o(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&u(this,n,t),r&&u(this,r,arguments),this},listenTo:function(e,t,r,i){i=i||this;var s=this._listeners||(this._listeners={}),o=e._listenerId||(e._listenerId=n.uniqueId("l"));return s[o]=e,e.on(t,r||i,i),this},stopListening:function(e,t,n,r){r=r||this;var i=this._listeners;if(!i)return;if(e)e.off(t,n,r),!t&&!n&&delete i[e._listenerId];else{for(var s in i)i[s].off(null,null,r);this._listeners={}}return this}};a.bind=a.on,a.unbind=a.off;var f=t.RuleConstants={opts1Prefix:"<-",opts2Prefix:"->"},l=t.Rule=function(e,t,n,r){this.selector1=e,this.selector2=t,this.name=n,this.opts={},this.opts1={},this.opts2={},this.initialize(r)};n.extend(l.prototype,{initialize:function(e){n.each(n.pairs(e),function(e){var t;e[0].indexOf(RelationConstants.opts1Prefix)===0?(t=e[0].substring(f.opts1Prefix.length).trim(),this.opts1[t]=e[1]):e[0].indexOf(RelationConstants.opts2Prefix)===0?(t=e[0].substring(f.opts2Prefix.length).trim(),this.opts2[t]=e[1]):this.opts[e[0]]=e[1]})},addOption:function(e,t){this.opts[e]=t},head:function(){return this.selector1},tail:function(){return this.selector2}});var c=t.Selector={toString:function(){return"<Selector {tree:"+this.treeName+", type:"+this.treeType+", selector:"+this.selector+", variant:"+this.variant+"}>"},PreParse:function(e){var r="body",i="html",s=null,o=t.$.trim(e);if(o[0]=="@"){var u=o.split("|");if(u.length==1)throw new Error("Cound not parse: "+self.stringSpec);r=t.$.trim(u.shift().substring(1)),s=t.$.trim(n.join(u,""))}else s=e;return[r,i,s]},Create:function(e){var t=this.PreParse(e),n=null;return t[1]=="html"&&(n=new h(t[2])),console.log("s",n),n!==null&&(n.treeName=t[0],n.treeType=t[1],n.originalString=e),n}},h=t.DomSelector=function(e){this.treeName=null,this.treeType=null,this.originalString=null,this._selection=null,this.selector=e,this.inline=!1,this.inlineNode=null};n.extend(h.prototype,c,{matches:function(e){console.log("DomSelector::Matches ",e,this.inlineNode,e==this.inlineNode,this.originalString);if(this.inline)return console.log("DomSelector::matches inline!",this.inlineNode,e),this.inlineNode==e;var t=this.treeName==e.tree.name&&e.node.is(this.selector);return console.log("DomSelector::matches tree",this.treeName," / ",e.tree.name," selector ",this.selector," / ",e.node.is(this.selector),"res",t),t},toSelection:function(e){return console.log("DomSelector::toSelection",this.originalString),this.inline===!0?this.inlineNode===null?new t.Selection:new t.Selection([this.inlineNode]):(this._selection===null&&(this._selection=e.selectionForSelector(this)),this._selection)}});var p=t.RuleParser={incorporate:function(e,r,i,s){console.log("RuleParser::incorporate start");var o=i.split(";");n.each(o,function(i){var o=i.split(":");if(o.length==2){var u="",a="",f="",h=t.$.trim(o[0]),p=t.$.trim(o[1]),d=0;for(var v=0;v<h.length;v++)if(h[v]=="-"&&d===0)d=1;else if(h[v]=="(")d=2;else{if(h[v]==")"&&d==2)break;d===0?a+=h[v]:d==1?f+=h[v]:d==2&&(u+=h[v])}console.log("RuleParser::incorporate selector",r,"key",h,"value",p);var m=c.Create(r);typeof s!="undefined"&&(m.inline=!0,m.inlineNode=s),u.length>0&&(m.variant=u);var g=m.toString();console.log("RuleParser::incorporate selector1",m,g),n.contains(e,g)||(console.log("RuleParser::incorporate Creating slot for selector 1",m),e[g]={}),n.contains(e[g],a)||(console.log("RuleParser::incorporate Creating new rule for selector 1 :: name",m,a),e[g][a]=new l(m,null,a,{}));if(f.length===0){var y=c.Create(p);console.log("RuleParser::incorporate selector2",y,p),e[g][a].selector2=y}else e[g][a].addOption(f,p);console.log("RuleParser::incorporate Final after adding rule",e[g][a])}},this)},parse:function(e){function l(){var e=t.$.trim(r.substr(f,u-f-1)),n=t.$.trim(r.substr(u+1,a-u-1));f=a+1,i.incorporate(s,e,n)}var i=this,s={};r=e.replace(/\/\*(\r|\n|.)*\*\//g,"");var o=0,u=-1,a=0,f=0;for(var c=0;c<r.length;c++)r[c]=="{"?(o++,o==1&&(console.log("RuleParser::Parse",r[c]),u=c)):r[c]=="}"&&(o--,o===0&&(a=c,l()));var h=[];return n.each(n.values(s),function(e){h=n.union(h,n.values(e))}),console.log("RuleParser::parse",h),h},parseInline:function(e,t){var r={};this.incorporate(r,"_inline_",t,e);var i=[];return n.each(n.values(r),function(e){i=n.union(i,n.values(e))}),console.log("RuleParser::parseInline returning",i),i}};t.Node={initializeStateMachine:function(){this.fsmInitialize("Ready",[{from:"Ready",to:"BeginRender",name:"BeginRender"},{from:"BeginRender",to:"ProcessIncoming",name:"ProcessIncoming"},{from:"ProcessIncoming",to:"ProcessIncomingChildren",name:"ProcessIncomingChildren"},{from:"ProcessIncomingChildren",to:"ProcessedIncoming",name:"ProcessedIncoming"},{from:"ProcessIncoming",to:"FailedConditional",name:"FailedConditional"},{from:"FailedConditional",to:"Finished",name:"Finished_Invisible"},{from:"ProcessedIncoming",to:"Finished",name:"Finished_NoTemplate"},{from:"ProcessIncomming",to:"ProcessedIncoming",name:"SkipRecursion"}]),this.on("FsmEdge:BeginRender",this._onBeginRender,this),this.on("FsmEdge:ProcessIncoming",this._onProcessIncoming,this),this.on("FsmEntered:ProcessIncomingChildren",this._onProcessIncomingChildren,this),this.on("FsmEntered:ProcessedIncoming",this._onProcessedIncoming,this),this.on("FsmEdge:FailedConditional",this._onFailedConditional,this),this.on("FsmEntered:Finished",this._onFinished,this)},render:function(e){console.log(this,"render");if(!n.isUndefined(e)&&n.has(e,"callback")){var t=this;n.has(e,"callbackScope")&&(t=e.callbackScope),this.once("FsmEntered:Finished",e.callback,t)}this.fsmTransition("BeginRender")},getChildren:function(){return(n.isUndefined(this.children)||n.isNull(this.children))&&this._createChildren(),this.children},registerRelation:function(e){n.contains(this.relations,e)||this.relations.push(e)},getRelations:function(){return this.searchedForRelations||(typeof this.tree!="undefined"&&typeof this.tree.forrest!="undefined"&&this.tree.forrest.registerRelationsForNode(this),this.searchedForRelations=!0),this.relations},treeSize:function(){return 1+this.getChildren().length},subtreeRelations:function(){var e=this.tree.forrest.relationsForNode(this),t=this.getChildren();for(var r=0;r<t.length;r++)e=n.union(e,t[r].subtreeRelations());return e},getInlineRules:function(){return null},_onBeginRender:function(){console.log(this,"onBeginRender"),this.fsmTransition("ProcessIncoming")},_onProcessIncoming:function(){console.log(this,"onProcessIncoming"),this._performConditional()?this._performIs()?(console.log("Performed is"),this.fsmTransition("ProcessedIncoming")):this._performAre()?this.fsmTransition("ProcessIncomingChildren"):this.fsmTransition("ProcessIncomingChildren"):(console.log("Fail conditional"),this.fsmTransition("FailedConditional"))},_onProcessIncomingChildren:function(){console.log(this,"onProcessChildren");var e=this.getChildren();this.outstandingChildren=e.length,this.outstandingChildren===0?this.fsmTransition("ProcessedIncoming"):(n.each(e,function(e){e.on("FsmEntered:Finished",this._onChildFinished,this)},this),n.each(e,function(e){console.log("RENDERING CHILD"),e.render()},this))},_onChildFinished:function(){this.outstandingChildren=this.outstandingChildren-1,this.outstandingChildren===0&&this.fsmTransition("ProcessedIncoming")},_onProcessedIncoming:function(){console.log("Trans to finish"),this.fsmTransition("Finished")},_onFailedConditional:function(){this.failedConditional(),this.fsmTransition("Finished")},_onFinished:function(){},_performConditional:function(){var e=n.filter(this.relations,function(e){return(e.name=="ifexist"||e.name=="ifnexist")&&e.head().contains(this)},this);return e.length===0?!0:n.all(e,function(e){var t=e.tail().nodes,r=!n.isUndefined(t)&&t.length>0;return r&&e.name=="ifexist"||!r&&e.name=="ifnexist"},this)},_performIs:function(){var e=null;return n.each(this.relations,function(t){console.log(t),t.name=="is"&&(console.log("is is!"),t.head().contains(this)&&(console.log("contains this!"),console.log("Perform is"),e=t))},this),e?(console.log("Found IS rule"),this.isIncoming(e.tail()),!0):!1},_performAre:function(){var e=null;return n.each(this.relations,function(t){t.name=="are"&&(console.log("FOUND AN ARE"),t.head().contains(this)&&(e=t))},this),e?(console.log("Found ARE rule"),this.areIncoming(e.tail(),e),!0):!1}};var d=t.DomNode=function(e,r,i,s,o){var u;this.children=null,this.parentNode=null,this.relations=[],this.searchedForRelations=!1,this.isSiblingGroup=!1,this.isEnumerable=!1,typeof e=="object"?n.isUndefined(e.jquery)?e instanceof Array?this.siblings=e:e instanceof Element?this.siblings=[$(e)]:this.siblings=[]:(t.Debugging.DumpStack(),this.siblings=[e]):typeof e=="string"?this.siblings=n.map($(e),function(e){return $(e)}):this.siblings=[],this.siblings.length>1&&(this.isSiblingGroup=!0),this.tree=r,typeof i!="undefined"&&(this.relations=i),this.opts=s||{},this.initialize.apply(this,o)};n.extend(t.DomNode.prototype,t.Events,t.StateMachine,t.Node,{initialize:function(e){this.initializeStateMachine()},destroy:function(e){this.parentNode.unregisterChild(this),n.each(this.siblings,function(e){e.remove()})},debugName:function(){return n.map(this.siblings,function(e){return e[0].nodeName}).join(", ")},clone:function(e){console.log("SIBSIB",this.siblings);var t=n.map(this.siblings,function(e){return e.clone()}),r=new d(t,this.tree,[],this.opts),i=n.map(this.relations,function(e){var t=e.clone();return t.selection1.nodes.contains(this)?t.selection1.nodes=n.without(t.selection1.nodes,this).push(r):t.selection2.nodes.contains(this)&&(t.selection2.nodes=n.without(t.selection2.nodes,this).push(r)),t},this);return this.parentNode.registerChild(r,{after:this,andInsert:!0}),r},unregisterChild:function(e,t){this.children=n.without(this.children,e)},registerChild:function(e,t){console.log("registerChild",this,e),this.children===null&&this._createChildren();var r=!1;if(!n.isUndefined(t)&&!n.isUndefined(t.after))for(var i=this.children.length-1;i>=0;i--)if(this.children[i]==t.after){for(var s=this.children.length-1;s>i;s--)this.children[s+1]=this.children[s];this.children[i+1]=e,e.parentNode=this,typeof t!="undefined"&&typeof t.andInsert!="undefined"&&t.andInsert===!0&&this.children[i].siblings[this.children[i].siblings.length-1].after(e.siblings),r=!0}if(!r){console.log("FFFF",this.children);var o=this.children[this.children.length-1];console.log("Last Child",o,this),this.children[this.children.length]=e,typeof t!="undefined"&&typeof t.andInsert!="undefined"&&t.andInsert===!0&&o.siblings[o.siblings.length-1].after(e.siblings),e.parentNode=this}},getInlineRules:function(){if(this.isSiblingGroup===!0)return null;var e=this.siblings[0].attr("data-cts");return console.log("SIBS",this.siblings[0],this.siblings[0].html(),this.siblings),e!==null&&typeof e!="undefined"?e:null},_findChildIn:function(e){while(e.length>0){var r=t.$(e.shift()),i=new d(r,this.tree),s=i.getRelations();s.length>0?(console.log("RELATIONS OH MY",r,i,s),i.relations=s,this.registerChild(i)):e=n.union(e,r.children().toArray())}},_createChildren:function(){console.log("DomNode::createChildren",this),this.children=[];if(this.isSiblingGroup===!0)n.each(this.siblingGroup,function(e){this.registerChild(e)},this);else if(this.siblings.length>1)t.Debugging.Fatal("Siblings > 1",this);else{var e=this.siblings[0].children().toArray(),r=n.filter(this.getRelations(),function(e){return e.name=="are"},this);if(r.length>1)t.Debugging.Log.Fatal("We don't know what to do with >1 ARE for a node yet.",this);else if(r.length>0){var i=[],s=0,o=r[0].optsFor(this);for(s=0;s<o.prefix;s++)i.push(e[s]);this._findChildIn(i);var u=0,a=e.length-o.suffix;for(s=o.prefix;s<a;s+=o.step){var f=[];for(var l=0;l<o.step;l++)f.push(t.$(e[s+l])),u=s+l;console.log("New",f);var c=new t.DomNode(f,this.tree);c.isEnumerable=!0,this.registerChild(c)}u+=1,i=[];for(s=u;s<e.length;s++)i.push(e[s]);this._findChildIn(i)}else this._findChildIn(this.siblings[0].children().toArray())}console.log("Create Children Returned: ",this.children)},failedConditional:function(){n.each(this.siblings,function(e){e.hide()})},isIncoming:function(e,t){console.log("IS Incoming with otherNodes",e);if(e.nodes.length===0)n.each(this.siblings,function(e){e.html("")});else{var r=n.map(e.nodes,function(e){return e.isOutgoing(t)}).join("");n.each(this.siblings,function(e){e.html(r)})}},isOutgoing:function(e){return n.map(this.siblings,function(e){return e.html()}).join("")},areIncoming:function(e,t,r){console.log("DomNode::areIncoming");var i=n.filter(this.getChildren(),function(e){return e.isEnumerable});if(i.length===0){console.log("Bailing out of areIncoming");return}console.log("otherSelection",e.nodes);var s=n.flatten(n.map(e.nodes,function(e){return e.areOutgoing(t,r)})),o=Math.abs(i.length-s.length),u;if(i.length>s.length)for(u=0;u<o;u++){var a=i.pop();a.destroy(),console.log(i)}else if(i.length<s.length){var f=i[i.length-1];for(u=0;u<o;u++)console.log("going to clone"),i[i.length]=f.clone()}},areOutgoing:function(e,t){console.log("areOutgoing");var r=n.filter(this.getChildren(),function(e){return e.isEnumerable});return console.log("areOutgoing",r),r}});var v=t.RelationOpts={prefix:0,suffix:0,step:1},m=t.Relation=function(e,t,r,i,s,o){this.selection1=e,this.selection2=t,this.name=r,this.opts=i,this.opts1=n.extend(v,s),this.opts2=n.extend(v,o)};n.extend(m.prototype,{addOption:function(e,t){this.opts[e]=t},head:function(){return this.selection1},tail:function(){return this.selection2},optsFor:function(e){return this.selection1.contains(e)?this.opts1:this.selection2.contains(e)?this.opts2:{}},clone:function(){return new t.Relation(this.selection1.clone(),this.selection2.clone(),this.name,this.opts,this.opts1,this.opts2)}});var g=t.Selection=function(e,t){this.nodes=e,this.opts={},typeof t!="undefined"&&(this.opts=n.extend(this.opts,t))};n.extend(g.prototype,{contains:function(e){return n.contains(this.nodes,e)},clone:function(){return new t.Selection(n.union([],this.nodes),this.opts)}});var y=t.Tree={name:"",render:function(e){console.log("render root",this.root),this.root.render(e)}},b=t.DomTree=function(e,n,r){console.log("DomTree::constructor",e,n),this.root=n||new t.DomNode("body",this),this.forrest=e,this.name="body",typeof r!="undefined"&&"name"in r&&(this.name=r.name)};n.extend(b.prototype,y,{selectionForSelector:function(e){var r=this.root.siblings[0].find(e.selector).toArray(),i=n.map(r,function(e){return new d(t.$(e),this)},this);return console.log("Tree",this,"nodes for selection",e,i),new t.Selection(i)}});var w=t.JsonTree=function(e,t,n){this.forrest=e,this.root=t||window};n.extend(w.prototype,y,{});var E=t.Forrest=function(e,t){this.trees={},this.rules=[],this.initialize.apply(this,t)};n.extend(E.prototype,{initialize:function(){this.addDefaultTrees()},containsTreeAlias:function(e){n.has(this.trees,e)},addTree:function(e,t){this.trees[e]=t},addRule:function(e){this.rules[this.rules.length]=e},addRules:function(e){for(var t=0;t<e.length;t++)this.rules[this.rules.length]=e[t]},selectionForSelector:function(e){return console.log("Forrest::selectionForSelector trees",this.trees,"selector name",e.treeName),typeof this.trees[e.treeName]!="undefined"?(console.log("Forrest::SelectionForSelector --> Tree "+e.treeName+" ::SelectionforSelector"),this.trees[e.treeName].selectionForSelector(e)):(console.log("Nodes for selector bailing"),new t.Selection([]))},getPrimaryTree:function(){return this.trees.body},ingestRules:function(e){var t=p.parse(e);this.addRules(t)},addDefaultTrees:function(){this.addTree("body",new t.DomTree(this)),this.addTree("window",new t.JsonTree(this,window))},rulesForNode:function(e){console.log("Forrest:::rulesForNode");var t=[];n.each(this.rules,function(n){console.log("Forrest::rulesForNode Rule",n,"for node",e),n.selector1.matches(e)||n.selector2.matches(e)?t[t.length]=n:(console.log("Failed match",n.selector1.selector),console.log("Failed match",n.selector2.selector))},this);var r=e.getInlineRules();if(r!==null){var i=p.parseInline(e,r);typeof i!="undefined"&&(t=n.union(t,i))}return t},registerRelationsForNode:function(e){console.log("Forrest::RelationsForNode");var r=this.rulesForNode(e);console.log("Rules for",e.siblings[0].html(),r);var i=n.map(r,function(r){var i=null,s=null,o=null,u=null;r.selector1.matches(e)?(i=new t.Selection([e]),s=r.selector2.toSelection(this),u=s):(s=new t.Selection([e]),i=r.selector1.toSelection(this),u=i);var a=new m(i,s,r.name,r.opts,r.opts1,r.opts2);e.registerRelation(a),n.each(u.nodes,function(e){e.registerRelation(a)},this)},this);return console.log("Returning Relations for",e.siblings[0].html(),i),i}});var S=t.Engine=function(e,t){var n;this.opts=e||{},this.forrest=null,this.initialize.apply(this,t)};n.extend(S.prototype,a,i,{initialize:function(){this.forrest=new t.Forrest},render:function(e){var t=this.forrest.getPrimaryTree(),r=n.extend({},e);t.render(r)},ingestRules:function(e){this.forrest.ingestRules(e)},loadRemoteString:function(e,t,r){$.ajax({url:e.url,dataType:"text",success:success,error:error,beforeSend:function(t,r){n.each(e,function(e,n,r){t[n]=e},this)}})},boot:function(){console.log("Boot"),this.fsmInitialize("Start",[{from:"Start",to:"QueueingCTS",name:"Begin"},{from:"QueueingCTS",to:"LoadingCTS",name:"QueuedCTS"},{from:"LoadingCTS",to:"QueueingTrees",name:"LoadedCTS"},{from:"QueueingTrees",to:"LoadingTrees",name:"QueuedTrees"},{from:"LoadingTrees",to:"Rendering",name:"LoadedTrees"},{from:"Rendering",to:"Rendered",name:"Rendered"}]),this.on("FsmEdge:Begin",this._fsmQueueCts,this),this.on("FsmEdge:LoadedCTS",this._fsmQueueTrees,this),this.on("FsmEdge:LoadedTrees",this._fsmRender,this),this.fsmTransition("QueueingCTS")},_fsmQueueCts:function(){console.log("FSM Queue CTS"),this.fsmTransition("LoadingCTS"),this._ctsToLoad={};var e=!1;n.each(t.$('script[type="text/cts"]'),function(n){var r=t.$(n);r.attr("src")?(this._ctsToLoad[r.attr("src")]=!0,e=!0,this.loadRemoteString({url:r.attr("src")},_fsmCtsLoadSuccess,_fsmCtsLoadFail)):this.ingestRules(r.html())},this),e||this.fsmTransition("QueueingTrees")},_fsmQueueTrees:function(){console.log("FSM Queue Trees"),this.fsmTransition("LoadingTrees"),this._treesToLoad={};var e=!1;n.each(this.forrest.trees,function(e,t,n){console.log("TREE")},this),e||this.fsmTransition("Rendering")},_fsmRender:function(){console.log("FSM Render"),this.render(),this.fsmTransition("Rendered")},_fsmCtsLoadSuccess:function(e,t,n){this.ingestRules(e),this._fsmCtsLoaded(n.url)},_fsmCtsLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmTreeLoadSuccess:function(e,t,n){this._fsmCtsLoaded(n.url)},_fsmTreeLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmCtsLoaded:function(e){delete this._ctsToLoad[e];var t=this._ctsToLoad.length===0;t&&_fsmTransition("QueueingTrees")},_fsmTreeLoaded:function(e){done&&_fsmTransition("Rendering")}}),t.Debugging={DumpStack:function(){var e=new Error("dummy"),t=e.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n");console.log(t)}},t.Debugging.Log={Fatal:function(e,t){alert(e),console.log("FATAL",e,t)}};var x=t.Debugging.TreeViz=function(e){this.forrest=e,this.init(),this.finish()};n.extend(x.prototype,{write:function(e){this.win.document.write(e)},init:function(){this.win=window.open("","CTS Tree Visualization","width=1000,height=800,scrollbars=1,resizable=1"),this.win.document.open(),this.write("<html><head>"),this.write('<script src="http://d3js.org/d3.v3.min.js"></script>'),this.write('<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>'),this.write('<script src="http://people.csail.mit.edu/eob/files/cts/extras/tree.js"></script>'),this.write('<link rel="stylesheet" href="http://people.csail.mit.edu/eob/files/cts/extras/tree.css"></script>'),this.writeTree(this.forrest.getPrimaryTree()),this.write('</head><body><div id="chart"></div>')},finish:function(){this.write("</body><html>"),this.win.document.close()},writeTree:function(e){this.write("<script>"),this.write("window.treeData = "),this.writeNode(e.root),this.write(";"),this.write("</script>")},writeNode:function(e){this.write("{"),this.write('name:"'+e.debugName()+'"');var t=e.getChildren();console.log(t),console.log("Kids size for node",e,t.length);if(typeof t!="undefined"&&t.length>0){this.write(", children: [");for(var n=0;n<t.length;n++)this.writeNode(t[n]),n<t.length-1&&this.write(",");this.write("]")}this.write("}")}})}).call(this);