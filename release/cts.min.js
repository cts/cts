/**
* cts
 * Declarative structural remapping for the web.
 *
 * @author Ted Benson <eob@csail.mit.edu>>
 * @copyright Ted Benson 2013
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://www.treesheets.org
 * @module cts
 * @version 0.5.0
 */
(function(){var e=this,t;typeof exports!="undefined"?t=exports:t=e.CTS={},t.VERSION="0.1.0",t.$=e.jQuery;var n=e._;!n&&typeof require!="undefined"&&(n=require("underscore"));var i=t.StateMachine={fsmInitialize:function(e,t,r){this._fsmCurrent=e,this._fsmArcs={},n.each(t,function(e){n.contains(this._fsmArcs,e.from)||(this._fsmArcs[e.from]={}),this._fsmArcs[e.from][e.to]=e.name},this)},fsmCurrentState:function(){return this._fsmCurrent},fsmCanTransition:function(e){return this._fsmArcs[this._fsmCurrent]&&this._fsmArcs[this._fsmCurrent][e]?!0:!1},fsmTransition:function(e){if(!this.fsmCanTransition)throw new Error("Can not make transition "+this._fsmCurrent+" -> "+e);var t=this._fsmCurrent,n=e,r=this._fsmArcs[t][n];this.trigger("FsmLeft:"+t),this._fsmCurrent=n,console.log("Transitioning to",n),this.trigger("FsmEdge:"+r),this.trigger("FsmEntered:"+n)}},s=/\s+/,o=function(e,t,n,r){if(!n)return!0;if(typeof n=="object")for(var i in n)e[t].apply(e,[i,n[i]].concat(r));else{if(!s.test(n))return!0;var o=n.split(s);for(var u=0,a=o.length;u<a;u++)e[t].apply(e,[o[u]].concat(r))}},u=function(e,t,n){var r,i=-1,s=t.length;switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0]);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1]);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1],n[2]);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx,n)}},a=t.Events={on:function(e,t,r){if(!o(this,"on",e,[t,r])||!t)return this;if(n.isUndefined(this._events)||n.isNull(this._events))this._events={};var i=this._events[e]||(this._events[e]=[]);return i.push({callback:t,context:r,ctx:r||this}),this},once:function(e,t,r){if(!o(this,"once",e,[t,r])||!t)return this;var i=this,s=n.once(function(){i.off(e,s),t.apply(this,arguments)});return s._callback=t,this.on(e,s,r),this},off:function(e,t,r){var i,s,u,a,f,l,c,h;if(!this._events||!o(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events={},this;a=e?[e]:n.keys(this._events);for(f=0,l=a.length;f<l;f++){e=a[f],i=this._events[e];if(i){u=[];if(t||r)for(c=0,h=i.length;c<h;c++)s=i[c],(t&&t!==(s.callback._callback||s.callback)||r&&r!==s.context)&&u.push(s);this._events[e]=u}}return this},trigger:function(e){if(!this._events)return this;var t=[];arguments.length>1&&(t=arguments.slice(1,arguments.length));if(!o(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&u(this,n,t),r&&u(this,r,arguments),this},listenTo:function(e,t,r,i){i=i||this;var s=this._listeners||(this._listeners={}),o=e._listenerId||(e._listenerId=n.uniqueId("l"));return s[o]=e,e.on(t,r||i,i),this},stopListening:function(e,t,n,r){r=r||this;var i=this._listeners;if(!i)return;if(e)e.off(t,n,r),!t&&!n&&delete i[e._listenerId];else{for(var s in i)i[s].off(null,null,r);this._listeners={}}return this}};a.bind=a.on,a.unbind=a.off,t.Node={initializeStateMachine:function(){this.fsmInitialize("Ready",[{from:"Ready",to:"BeginRender",name:"BeginRender"},{from:"BeginRender",to:"ProcessIncoming",name:"ProcessIncoming"},{from:"ProcessIncoming",to:"ProcessIncomingChildren",name:"ProcessIncomingChildren"},{from:"ProcessIncomingChildren",to:"ProcessedIncoming",name:"ProcessedIncoming"},{from:"ProcessIncoming",to:"FailedConditional",name:"FailedConditional"},{from:"FailedConditional",to:"Finished",name:"Finished_Invisible"},{from:"ProcessedIncoming",to:"Finished",name:"Finished_NoTemplate"},{from:"ProcessIncomming",to:"ProcessedIncoming",name:"SkipRecursion"}]),this.on("FsmEdge:BeginRender",this._onBeginRender,this),this.on("FsmEdge:ProcessIncoming",this._onProcessIncoming,this),this.on("FsmEntered:ProcessIncomingChildren",this._onProcessIncomingChildren,this),this.on("FsmEdge:ProcessedIncoming",this._onProcessedIncoming,this),this.on("FsmEdge:FailedConditional",this._onFailedConditional,this),this.on("FsmEntered:Finished",this._onFinished,this)},render:function(){console.log(this,"render"),this.fsmTransition("BeginRender")},getChildren:function(){if(n.isUndefined(this.children)||n.isNull(this.children))this.children=this._createChildren();return this.children},_onBeginRender:function(){this.node.css("border","1px solid red"),console.log(this,"onBeginRender"),this.fsmTransition("ProcessIncoming")},_onProcessIncoming:function(){console.log(this,"onProcessIncoming"),this._performConditional()?this._performIs()?this.fsmTransition("ProcessedIncoming"):this._performRepeat()?this.fsmTransition("ProcessIncomingChildren"):this.fsmTransition("ProcessIncomingChildren"):(console.log("Fail conditional"),this.fsmTransition("FailedConditional"))},_onProcessIncomingChildren:function(){console.log(this,"onProcessChildren"),this.node.css("border","1px solid yellow");var e=this.getChildren();this.outstandingChildren=e.length,this.outstandingChildren===0?this.fsmTransition("ProcessedIncoming"):(n.each(e,function(e){e.on("FsmEntered:Finished",this._onChildFinished,this)},this),n.each(e,function(e){console.log("RENDERING CHILD"),e.render()},this))},_onChildFinished:function(){this.outstandingChildren=this.outstandingChildren-1,this.outstandingChildren===0&&this.fsmTransition("ProcessedIncoming")},_onProcessedIncoming:function(){this.fsmTransition("Finished")},_onFailedConditional:function(){this.node.hide(),this.fsmTransition("Finished")},_onFinished:function(){this.node.css("border","1px solid green")},_performConditional:function(){var e=n.filter(this.rules,function(e){return e.name=="ifexist"&&e.head().matches(this)},this);return e.length===0?!0:n.all(e,function(e){var t=e.tail().nodes(this.tree.forrest);return!n.isUndefined(t)&&t.length>0?!0:!1},this)},_performIs:function(){console.log("Perform IS on",this,this.node.html(),this.rules);var e=null;return n.each(this.rules,function(t){t.name=="is"&&t.head().matches(this)&&(e=t)},this),e?(console.log("Found IS rule"),this.isIncoming(e.tail().nodes(this.tree.forrest)),!0):!1},_performAre:function(){console.log("Perform ARE on",this,this.node.html(),this.rules);var e=null;return n.each(this.rules,function(t){t.name=="are"&&t.head().matches(this)&&(e=t)},this),e?(console.log("Found ARE rule"),this.areIncoming(e.tail().nodes(this.tree.forrest)),!0):!1},_performRepeat:function(){var e=n.filter(this.rules,function(e){return e.name=="repeat"&&e.head().matches(this)},this);if(e.length>0){var t=e[e.length-1],r=t.tail().nodes(this.tree.forrest);return typeof r.length!="undefined"&&r.length>0,!0}return!1}};var f=t.DomNode=function(e,t,n,r,i){var s;this.node=e,this.tree=t,this.children=null,this.rules=n||[],this.opts=r||{},this.parentNode=null,this.initialize.apply(this,i)};n.extend(t.DomNode.prototype,t.Events,t.StateMachine,t.Node,{initialize:function(e){this.initializeStateMachine()},destroy:function(e){this.node.remove()},clone:function(e){var t=this.node.clone();this.node.after(t);var n=new f(t,this.tree,this.rules,this.opts);this.parentNode.registerChild(n,{after:this})},registerChild:function(e,t){var r=!1;if(!n.isUndefined(t)&&!n.isUndefined(t.after))for(var i=this.children.length-1;i>=0;i--)if(this.children[i]==t.after){for(var s=this.children.length-1;s>i;s--)this.children[s+1]=this.children[s];this.children[i+1]=e,e.parentNode=this,r=!0}r||(this.children[this.children.length]=e,e.parentNode=this)},_createChildren:function(){var e=this.node.children().toArray(),r=[];while(e.length>0){var i=t.$(e.shift()),s=new f(i,this.tree),o=this.tree.forrest.rulesForNode(this.tree,s);console.log("Found child",s.node,s.node.html(),"with rules",o),o.length>0?(s.rules=o,this.registerChild(s)):e=n.union(e,i.children().toArray())}return console.log("Create Children Returned: ",r),r},isIncoming:function(e,t){console.log("IS Incoming with otherNodes",e),e.length===0?(console.log("Other nodes empty!"),this.node.html("")):(console.log("Other nodes non empty!"),this.node.html(e[e.length-1].isOutgoing(t)))},isOutgoing:function(e){return this.node.html()},areIncoming:function(e,t){var r=n.flatten(n.map(e,function(e){e.areOutgoing(opt)},this)),i=n.filter(gets.node.getChildren(),function(e){e.node.is("[itemscope]")},this),s=Math.abs(i.length-r.length),o;if(i.length>r.length)for(o=0;o<s;o++)i[i.length-1].destroy();else if(i.length<r.length)for(o=0;o<s;o++)i[i.length]=i[i.length-1].clone()},areOutgoing:function(e){n.filter(this.node.getChildren(),function(e){e.node.is("[itemscope]")},this)}});var l=t.Forrest=function(e,t){this.trees={},this.rules=[],this.initialize.apply(this,t)};n.extend(l.prototype,{initialize:function(){this.addDefaultTrees()},containsTreeAlias:function(e){n.has(this.trees,e)},addTree:function(e,t){this.trees[e]=t},addRule:function(e){this.rules[this.rules.length]=e},addRules:function(e){for(var t=0;t<e.length;t++)this.rules[this.rules.length]=e[t]},nodesForSelection:function(e){return console.log("trees",this.trees,"selection name",e.treeName),typeof this.trees[e.treeName]!="undefined"?this.trees[e.treeName].nodesForSelection(e):(console.log("Nodes for selection bailing"),[])},getPrimaryTree:function(){return this.trees.body},ingestRules:function(e){var t=g.parse(e);this.addRules(t)},addDefaultTrees:function(){this.addTree("body",new t.DomTree(this)),this.addTree("window",new t.JsonTree(this,window))},rulesForNode:function(e,t){var r=[];return n.each(this.rules,function(e){console.log("Rule",e,"for node",t),e.selection1.matches(t)||e.selection2.matches(t)?r[r.length]=e:(console.log("Failed match",e.selection1.selector),console.log("Failed match",e.selection2.selector))},this),console.log("Rules for node: ",r),r}});var c=t.Tree={name:"",render:function(e){console.log("render root",this.root),this.root.render(e)}},h=t.DomTree=function(e,n,r){this.root=n||new t.DomNode(t.$("body"),this),this.forrest=e,this.name="body",typeof r!="undefined"&&"name"in r&&(this.name=r.name)};n.extend(h.prototype,c,{nodesForSelection:function(e){var r=this.root.node.find(e.selector).toArray(),i=n.map(r,function(e){return new f(t.$(e),this)},this);return console.log("Tree",this,"nodes for selection",e,i),i}});var p=t.JsonTree=function(e,t,n){this.forrest=e,this.root=t||window};n.extend(p.prototype,c,{});var d=t.Selection={toString:function(){return"<Selection {tree:"+this.treeName+", type:"+this.treeType+", selector:"+this.selector+", variant:"+this.variant+"}>"},PreParse:function(e){var r="body",i="html",s=null,o=t.$.trim(e);if(o[0]=="@"){var u=o.split("|");if(u.length==1)throw new Error("Cound not parse: "+self.stringSpec);r=t.$.trim(u.shift().substring(1)),s=t.$.trim(n.join(u,""))}else s=e;return[r,i,s]},Create:function(e){var t=this.PreParse(e),n=null;return t[1]=="html"&&(n=new v(t[2])),console.log("s",n),n!==null&&(n.treeName=t[0],n.treeType=t[1],n.originalString=e),n}},v=t.DomSelection=function(e){this.treeName=null,this.treeType=null,this.originalString=null,this._nodes=null,this.selector=e};n.extend(v.prototype,d,{matches:function(e){return console.log("this treename",this.treeName,"node",e.tree.name),console.log("node is <",this.selector,">",e.node.is(this.selector)),this.treeName==e.tree.name&&e.node.is(this.selector)},nodes:function(e){return this._nodes===null&&(this._nodes=e.nodesForSelection(this)),this._nodes}});var m=t.Rule=function(e,t,n,r){this.selection1=e,this.selection2=t,this.name=n,this.opts=r||{}};n.extend(m.prototype,{addOption:function(e,t){this.opts[e]=t},head:function(){return this.selection1},tail:function(){return this.selection2}});var g=t.RelationParser={incorporate:function(e,r,i){console.log("hi");var s=i.split(";");n.each(s,function(i){var s=i.split(":");if(s.length==2){var o="",u="",a="",f=t.$.trim(s[0]),l=t.$.trim(s[1]),c=0;for(var h=0;h<f.length;h++)if(f[h]=="-"&&c===0)c=1;else if(f[h]=="(")c=2;else{if(f[h]==")"&&c==2)break;c===0?u+=f[h]:c==1?a+=f[h]:c==2&&(o+=f[h])}console.log("selector",r,"key",f,"value",l);var p=d.Create(r);o.length>0&&(p.variant=o);var v=p.toString();console.log("selection1",p,v),n.contains(e,v)||(console.log("Creating slot for selection 1",p),e[v]={}),n.contains(e[v],u)||(console.log("Creating new rule for selection 1 :: name",p,u),e[v][u]=new m(p,null,u,{}));if(a.length===0){var g=d.Create(l);console.log("selection2",g,l),e[v][u].selection2=g}else e[v][u].addOption(a,l);console.log("Final after adding rule",e[v][u])}},this)},parse:function(e){function l(){var e=t.$.trim(r.substr(f,u-f-1)),n=t.$.trim(r.substr(u+1,a-u-1));f=a+1,i.incorporate(s,e,n)}var i=this,s={};r=e.replace(/\/\*(\r|\n|.)*\*\//g,"");var o=0,u=-1,a=0,f=0;for(var c=0;c<r.length;c++)r[c]=="{"?(o++,o==1&&(console.log(r[c]),u=c)):r[c]=="}"&&(o--,o===0&&(a=c,l()));var h=[];return n.each(n.values(s),function(e){h=n.union(h,n.values(e))}),console.log(h),h}},y=t.Engine=function(e,t){var n;this.opts=e||{},this.forrest=null,this.initialize.apply(this,t)};n.extend(y.prototype,a,i,{initialize:function(){this.forrest=new t.Forrest},render:function(){var e=this.forrest.getPrimaryTree();e.render()},ingestRules:function(e){this.forrest.ingestRules(e)},loadRemoteString:function(e,t,r){$.ajax({url:e.url,dataType:"text",success:success,error:error,beforeSend:function(t,r){n.each(e,function(e,n,r){t[n]=e},this)}})},boot:function(){console.log("Boot"),this.fsmInitialize("Start",[{from:"Start",to:"QueueingCTS",name:"Begin"},{from:"QueueingCTS",to:"LoadingCTS",name:"QueuedCTS"},{from:"LoadingCTS",to:"QueueingTrees",name:"LoadedCTS"},{from:"QueueingTrees",to:"LoadingTrees",name:"QueuedTrees"},{from:"LoadingTrees",to:"Rendering",name:"LoadedTrees"},{from:"Rendering",to:"Rendered",name:"Rendered"}]),this.on("FsmEdge:Begin",this._fsmQueueCts,this),this.on("FsmEdge:LoadedCTS",this._fsmQueueTrees,this),this.on("FsmEdge:LoadedTrees",this._fsmRender,this),this.fsmTransition("QueueingCTS")},_fsmQueueCts:function(){console.log("FSM Queue CTS"),this.fsmTransition("LoadingCTS"),this._ctsToLoad={};var e=!1;n.each(t.$('script[type="text/cts"]'),function(n){var r=t.$(n);r.attr("src")?(this._ctsToLoad[r.attr("src")]=!0,e=!0,this.loadRemoteString({url:r.attr("src")},_fsmCtsLoadSuccess,_fsmCtsLoadFail)):this.ingestRules(r.html())},this),e||this.fsmTransition("QueueingTrees")},_fsmQueueTrees:function(){console.log("FSM Queue Trees"),this.fsmTransition("LoadingTrees"),this._treesToLoad={};var e=!1;n.each(this.forrest.trees,function(e,t,n){console.log("TREE")},this),e||this.fsmTransition("Rendering")},_fsmRender:function(){console.log("FSM Render"),this.render(),this.fsmTransition("Rendered")},_fsmCtsLoadSuccess:function(e,t,n){this.ingestRules(e),this._fsmCtsLoaded(n.url)},_fsmCtsLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmTreeLoadSuccess:function(e,t,n){this._fsmCtsLoaded(n.url)},_fsmTreeLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmCtsLoaded:function(e){delete this._ctsToLoad[e];var t=this._ctsToLoad.length===0;t&&_fsmTransition("QueueingTrees")},_fsmTreeLoaded:function(e){done&&_fsmTransition("Rendering")}})}).call(this);