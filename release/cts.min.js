/**
* cts
 * Declarative structural remapping for the web.
 *
 * @author Ted Benson <eob@csail.mit.edu>>
 * @copyright Ted Benson 2013
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://www.treesheets.org
 * @module cts
 * @version 0.5.0
 */
(function(){var e=this,t;typeof exports!="undefined"?t=exports:t=e.CTS={},t.VERSION="0.1.0",t.$=e.jQuery;var n=e._;!n&&typeof require!="undefined"&&(n=require("underscore"));var i=t.StateMachine={fsmInitialize:function(e,t,r){this._fsmCurrent=e,this._fsmArcs={},n.each(t,function(e){n.contains(this._fsmArcs,e.from)||(this._fsmArcs[e.from]={}),this._fsmArcs[e.from][e.to]=e.name},this)},fsmCurrentState:function(){return this._fsmCurrent},fsmCanTransition:function(e){return this._fsmArcs[this._fsmCurrent]&&this._fsmArcs[this._fsmCurrent][e]?!0:!1},fsmTransition:function(e){if(!this.fsmCanTransition)throw new Error("Can not make transition "+this._fsmCurrent+" -> "+e);var t=this._fsmCurrent,n=e,r=this._fsmArcs[t][n];this.trigger("FsmLeft:"+t),this._fsmCurrent=n,console.log("Transitioning to",n),this.trigger("FsmEdge:"+r),this.trigger("FsmEntered:"+n)}},s=/\s+/,o=function(e,t,n,r){if(!n)return!0;if(typeof n=="object")for(var i in n)e[t].apply(e,[i,n[i]].concat(r));else{if(!s.test(n))return!0;var o=n.split(s);for(var u=0,a=o.length;u<a;u++)e[t].apply(e,[o[u]].concat(r))}},u=function(e,t,n){var r,i=-1,s=t.length;switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0]);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1]);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1],n[2]);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx,n)}},a=t.Events={on:function(e,t,r){if(!o(this,"on",e,[t,r])||!t)return this;if(n.isUndefined(this._events)||n.isNull(this._events))this._events={};var i=this._events[e]||(this._events[e]=[]);return i.push({callback:t,context:r,ctx:r||this}),this},once:function(e,t,r){if(!o(this,"once",e,[t,r])||!t)return this;var i=this,s=n.once(function(){i.off(e,s),t.apply(this,arguments)});return s._callback=t,this.on(e,s,r),this},off:function(e,t,r){var i,s,u,a,f,l,c,h;if(!this._events||!o(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events={},this;a=e?[e]:n.keys(this._events);for(f=0,l=a.length;f<l;f++){e=a[f],i=this._events[e];if(i){u=[];if(t||r)for(c=0,h=i.length;c<h;c++)s=i[c],(t&&t!==(s.callback._callback||s.callback)||r&&r!==s.context)&&u.push(s);this._events[e]=u}}return this},trigger:function(e){if(!this._events)return this;var t=[];arguments.length>1&&(t=arguments.slice(1,arguments.length));if(!o(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&u(this,n,t),r&&u(this,r,arguments),this},listenTo:function(e,t,r,i){i=i||this;var s=this._listeners||(this._listeners={}),o=e._listenerId||(e._listenerId=n.uniqueId("l"));return s[o]=e,e.on(t,r||i,i),this},stopListening:function(e,t,n,r){r=r||this;var i=this._listeners;if(!i)return;if(e)e.off(t,n,r),!t&&!n&&delete i[e._listenerId];else{for(var s in i)i[s].off(null,null,r);this._listeners={}}return this}};a.bind=a.on,a.unbind=a.off;var f=t.Rule=function(e,t,n,r){this.selector1=e,this.selector2=t,this.name=n,this.opts=r||{}};n.extend(f.prototype,{addOption:function(e,t){this.opts[e]=t},head:function(){return this.selector1},tail:function(){return this.selector2}});var l=t.Selector={toString:function(){return"<Selector {tree:"+this.treeName+", type:"+this.treeType+", selector:"+this.selector+", variant:"+this.variant+"}>"},PreParse:function(e){var r="body",i="html",s=null,o=t.$.trim(e);if(o[0]=="@"){var u=o.split("|");if(u.length==1)throw new Error("Cound not parse: "+self.stringSpec);r=t.$.trim(u.shift().substring(1)),s=t.$.trim(n.join(u,""))}else s=e;return[r,i,s]},Create:function(e){var t=this.PreParse(e),n=null;return t[1]=="html"&&(n=new c(t[2])),console.log("s",n),n!==null&&(n.treeName=t[0],n.treeType=t[1],n.originalString=e),n}},c=t.DomSelector=function(e){this.treeName=null,this.treeType=null,this.originalString=null,this._selection=null,this.selector=e,this.inline=!1,this.inlineNode=null};n.extend(c.prototype,l,{matches:function(e){console.log("DomSelector::Matches ",e,this.inlineNode,e==this.inlineNode,this.originalString);if(this.inline)return console.log("DomSelector::matches inline!",this.inlineNode,e),this.inlineNode==e;var t=this.treeName==e.tree.name&&e.node.is(this.selector);return console.log("DomSelector::matches tree",this.treeName," / ",e.tree.name," selector ",this.selector," / ",e.node.is(this.selector),"res",t),t},toSelection:function(e){return console.log("DomSelector::toSelection",this.originalString),this.inline===!0?this.inlineNode===null?new t.Selection:new t.Selection([this.inlineNode]):(this._selection===null&&(this._selection=e.selectionForSelector(this)),this._selection)}});var h=t.RuleParser={incorporate:function(e,r,i,s){console.log("RuleParser::incorporate start");var o=i.split(";");n.each(o,function(i){var o=i.split(":");if(o.length==2){var u="",a="",c="",h=t.$.trim(o[0]),p=t.$.trim(o[1]),d=0;for(var v=0;v<h.length;v++)if(h[v]=="-"&&d===0)d=1;else if(h[v]=="(")d=2;else{if(h[v]==")"&&d==2)break;d===0?a+=h[v]:d==1?c+=h[v]:d==2&&(u+=h[v])}console.log("RuleParser::incorporate selector",r,"key",h,"value",p);var m=l.Create(r);typeof s!="undefined"&&(m.inline=!0,m.inlineNode=s),u.length>0&&(m.variant=u);var g=m.toString();console.log("RuleParser::incorporate selector1",m,g),n.contains(e,g)||(console.log("RuleParser::incorporate Creating slot for selector 1",m),e[g]={}),n.contains(e[g],a)||(console.log("RuleParser::incorporate Creating new rule for selector 1 :: name",m,a),e[g][a]=new f(m,null,a,{}));if(c.length===0){var y=l.Create(p);console.log("RuleParser::incorporate selector2",y,p),e[g][a].selector2=y}else e[g][a].addOption(c,p);console.log("RuleParser::incorporate Final after adding rule",e[g][a])}},this)},parse:function(e){function l(){var e=t.$.trim(r.substr(f,u-f-1)),n=t.$.trim(r.substr(u+1,a-u-1));f=a+1,i.incorporate(s,e,n)}var i=this,s={};r=e.replace(/\/\*(\r|\n|.)*\*\//g,"");var o=0,u=-1,a=0,f=0;for(var c=0;c<r.length;c++)r[c]=="{"?(o++,o==1&&(console.log("RuleParser::Parse",r[c]),u=c)):r[c]=="}"&&(o--,o===0&&(a=c,l()));var h=[];return n.each(n.values(s),function(e){h=n.union(h,n.values(e))}),console.log("RuleParser::parse",h),h},parseInline:function(e,t){var r={};this.incorporate(r,"_inline_",t,e);var i=[];return n.each(n.values(r),function(e){i=n.union(i,n.values(e))}),console.log("RuleParser::parseInline returning",i),i}};t.Node={initializeStateMachine:function(){this.fsmInitialize("Ready",[{from:"Ready",to:"BeginRender",name:"BeginRender"},{from:"BeginRender",to:"ProcessIncoming",name:"ProcessIncoming"},{from:"ProcessIncoming",to:"ProcessIncomingChildren",name:"ProcessIncomingChildren"},{from:"ProcessIncomingChildren",to:"ProcessedIncoming",name:"ProcessedIncoming"},{from:"ProcessIncoming",to:"FailedConditional",name:"FailedConditional"},{from:"FailedConditional",to:"Finished",name:"Finished_Invisible"},{from:"ProcessedIncoming",to:"Finished",name:"Finished_NoTemplate"},{from:"ProcessIncomming",to:"ProcessedIncoming",name:"SkipRecursion"}]),this.on("FsmEdge:BeginRender",this._onBeginRender,this),this.on("FsmEdge:ProcessIncoming",this._onProcessIncoming,this),this.on("FsmEntered:ProcessIncomingChildren",this._onProcessIncomingChildren,this),this.on("FsmEdge:ProcessedIncoming",this._onProcessedIncoming,this),this.on("FsmEdge:FailedConditional",this._onFailedConditional,this),this.on("FsmEntered:Finished",this._onFinished,this)},render:function(e){console.log(this,"render");if(!n.isUndefined(e)&&n.has(e,"callback")){var t=this;n.has(e,"callbackScope")&&(t=e.callbackScope),this.once("FsmEntered:Finished",e.callback,t)}this.fsmTransition("BeginRender")},getChildren:function(){return(n.isUndefined(this.children)||n.isNull(this.children))&&this._createChildren(),this.children},treeSize:function(){return 1+this.getChildren().length},getInlineRules:function(){return null},_onBeginRender:function(){this.node.css("border","1px solid red"),console.log(this,"onBeginRender"),this.fsmTransition("ProcessIncoming")},_onProcessIncoming:function(){console.log(this,"onProcessIncoming"),this._performConditional()?this._performIs()?this.fsmTransition("ProcessedIncoming"):this._performRepeat()?this.fsmTransition("ProcessIncomingChildren"):this.fsmTransition("ProcessIncomingChildren"):(console.log("Fail conditional"),this.fsmTransition("FailedConditional"))},_onProcessIncomingChildren:function(){console.log(this,"onProcessChildren"),this.node.css("border","1px solid yellow");var e=this.getChildren();this.outstandingChildren=e.length,this.outstandingChildren===0?this.fsmTransition("ProcessedIncoming"):(n.each(e,function(e){e.on("FsmEntered:Finished",this._onChildFinished,this)},this),n.each(e,function(e){console.log("RENDERING CHILD"),e.render()},this))},_onChildFinished:function(){this.outstandingChildren=this.outstandingChildren-1,this.outstandingChildren===0&&this.fsmTransition("ProcessedIncoming")},_onProcessedIncoming:function(){this.fsmTransition("Finished")},_onFailedConditional:function(){this.node.hide(),this.fsmTransition("Finished")},_onFinished:function(){this.node.css("border","1px solid green")},_performConditional:function(){var e=n.filter(this.rules,function(e){return e.name=="ifexist"&&e.head().matches(this)},this);return e.length===0?!0:n.all(e,function(e){var t=e.tail().toSelection(this.tree.forrest);return!n.isUndefined(t)&&t.length>0?!0:!1},this)},_performIs:function(){console.log("Perform IS on",this,this.node.html(),this.rules);var e=null;return n.each(this.rules,function(t){t.name=="is"&&t.head().matches(this)&&(e=t)},this),e?(console.log("Found IS rule"),this.isIncoming(e.tail().toSelection(this.tree.forrest)),!0):!1},_performAre:function(){console.log("Perform ARE on",this,this.node.html(),this.rules);var e=null;return n.each(this.rules,function(t){t.name=="are"&&t.head().matches(this)&&(e=t)},this),e?(console.log("Found ARE rule"),this.areIncoming(e.tail().toSelection(this.tree.forrest)),!0):!1},_performRepeat:function(){var e=n.filter(this.rules,function(e){return e.name=="repeat"&&e.head().matches(this)},this);if(e.length>0){var t=e[e.length-1],r=t.tail().toSelection(this.tree.forrest);return typeof r.length!="undefined"&&r.length>0,!0}return!1}};var p=t.DomNode=function(e,t,n,r,i){var s;this.node=e,this.tree=t,this.children=null,this.rules=n||[],this.opts=r||{},this.parentNode=null,this.initialize.apply(this,i)};n.extend(t.DomNode.prototype,t.Events,t.StateMachine,t.Node,{initialize:function(e){this.initializeStateMachine()},destroy:function(e){this.node.remove()},debugName:function(){return this.node[0].nodeName},clone:function(e){var t=this.node.clone();this.node.after(t);var n=new p(t,this.tree,this.rules,this.opts);this.parentNode.registerChild(n,{after:this})},registerChild:function(e,t){var r=!1;if(!n.isUndefined(t)&&!n.isUndefined(t.after))for(var i=this.children.length-1;i>=0;i--)if(this.children[i]==t.after){for(var s=children.length-1;s>i;s--)this.children[s+1]=this.children[s];this.children[i+1]=e,e.parentNode=this,r=!0}r||(this.children[this.children.length]=e,e.parentNode=this)},getInlineRules:function(){var e=this.node.attr("data-cts");return e!==null&&typeof e!="undefined"?e:null},_createChildren:function(){this.children=[],console.log("DomNode::createChildren",this);var e=this.node.children().toArray();while(e.length>0){console.log("Fringe length: ",e.length);var r=t.$(e.shift()),i=new p(r,this.tree),s=this.tree.forrest.relationsForNode(this.tree,i);(i.node.html()=="a"||i.node.html()=="b")&&console.log("Found child",i.node.html(),"with rules",s),s.length>0?(i.rules=s,this.registerChild(i)):(e=n.union(e,r.children().toArray()),console.log("New fringe length: ",e.length))}console.log("Create Children Returned: ",this.children)},isIncoming:function(e,t){console.log("IS Incoming with otherNodes",e),e.length===0?(console.log("Other nodes empty!"),this.node.html("")):(console.log("Other nodes non empty!"),this.node.html(e[e.length-1].isOutgoing(t)))},isOutgoing:function(e){return this.node.html()},areIncoming:function(e,t){var r=n.flatten(n.map(e,function(e){e.areOutgoing(opt)},this)),i=n.filter(gets.node.getChildren(),function(e){e.node.is("[itemscope]")},this),s=Math.abs(i.length-r.length),o;if(i.length>r.length)for(o=0;o<s;o++)i[i.length-1].destroy();else if(i.length<r.length)for(o=0;o<s;o++)i[i.length]=i[i.length-1].clone()},areOutgoing:function(e){n.filter(this.node.getChildren(),function(e){e.node.is("[itemscope]")},this)}});var d=t.Relation=function(e,t,n,r){this.node1=e,this.node2=t,this.name=n,this.opts=r||{}};n.extend(d.prototype,{addOption:function(e,t){this.opts[e]=t},head:function(){return this.node1},tail:function(){return this.node2}});var v=t.Selection=function(e,t){this.nodes=e,this.opts={},typeof t!="undefined"&&(this.opts=n.extend(this.opts,t))},m=t.Tree={name:"",render:function(e){console.log("render root",this.root),this.root.render(e)}},g=t.DomTree=function(e,n,r){this.root=n||new t.DomNode(t.$("body"),this),this.forrest=e,this.name="body",typeof r!="undefined"&&"name"in r&&(this.name=r.name)};n.extend(g.prototype,m,{selectionForSelector:function(e){var r=this.root.node.find(e.selector).toArray(),i=n.map(r,function(e){return new p(t.$(e),this)},this);return console.log("Tree",this,"nodes for selection",e,i),new t.Selection(i)}});var y=t.JsonTree=function(e,t,n){this.forrest=e,this.root=t||window};n.extend(y.prototype,m,{});var b=t.Forrest=function(e,t){this.trees={},this.rules=[],this.initialize.apply(this,t)};n.extend(b.prototype,{initialize:function(){this.addDefaultTrees()},containsTreeAlias:function(e){n.has(this.trees,e)},addTree:function(e,t){this.trees[e]=t},addRule:function(e){this.rules[this.rules.length]=e},addRules:function(e){for(var t=0;t<e.length;t++)this.rules[this.rules.length]=e[t]},selectionForSelector:function(e){return console.log("Forrest::selectionForSelector trees",this.trees,"selector name",e.treeName),typeof this.trees[e.treeName]!="undefined"?(console.log("Forrest::SelectionForSelector --> Tree "+e.treeName+" ::SelectionforSelector"),this.trees[e.treeName].selectionForSelector(e)):(console.log("Nodes for selector bailing"),new t.Selection([]))},getPrimaryTree:function(){return this.trees.body},ingestRules:function(e){var t=h.parse(e);this.addRules(t)},addDefaultTrees:function(){this.addTree("body",new t.DomTree(this)),this.addTree("window",new t.JsonTree(this,window))},rulesForNode:function(e,t){console.log("Forrest:::rulesForNode");var r=[];n.each(this.rules,function(e){console.log("Forrest::rulesForNode Rule",e,"for node",t),e.selector1.matches(t)||e.selector2.matches(t)?r[r.length]=e:(console.log("Failed match",e.selector1.selector),console.log("Failed match",e.selector2.selector))},this);var i=t.getInlineRules();if(i!==null){var s=h.parseInline(t,i);typeof s!="undefined"&&(r=n.union(r,s))}return r},relationsForNode:function(e,r){console.log("Forrest::RelationsForNode");var i=this.rulesForNode(e,r),s=n.map(i,function(e){var n=null,i=null,s=null;e.selector1.matches(r)?(n=new t.Selection([r]),i=e.selector2.toSelection(this)):(i=new t.Selection([r]),n=e.selector1.toSelection(this));var o=new d(n,i,e.opts);return o},this);return s}});var w=t.Engine=function(e,t){var n;this.opts=e||{},this.forrest=null,this.initialize.apply(this,t)};n.extend(w.prototype,a,i,{initialize:function(){this.forrest=new t.Forrest},render:function(e){var t=this.forrest.getPrimaryTree(),r=n.extend({},e);t.render(r)},ingestRules:function(e){this.forrest.ingestRules(e)},loadRemoteString:function(e,t,r){$.ajax({url:e.url,dataType:"text",success:success,error:error,beforeSend:function(t,r){n.each(e,function(e,n,r){t[n]=e},this)}})},boot:function(){console.log("Boot"),this.fsmInitialize("Start",[{from:"Start",to:"QueueingCTS",name:"Begin"},{from:"QueueingCTS",to:"LoadingCTS",name:"QueuedCTS"},{from:"LoadingCTS",to:"QueueingTrees",name:"LoadedCTS"},{from:"QueueingTrees",to:"LoadingTrees",name:"QueuedTrees"},{from:"LoadingTrees",to:"Rendering",name:"LoadedTrees"},{from:"Rendering",to:"Rendered",name:"Rendered"}]),this.on("FsmEdge:Begin",this._fsmQueueCts,this),this.on("FsmEdge:LoadedCTS",this._fsmQueueTrees,this),this.on("FsmEdge:LoadedTrees",this._fsmRender,this),this.fsmTransition("QueueingCTS")},_fsmQueueCts:function(){console.log("FSM Queue CTS"),this.fsmTransition("LoadingCTS"),this._ctsToLoad={};var e=!1;n.each(t.$('script[type="text/cts"]'),function(n){var r=t.$(n);r.attr("src")?(this._ctsToLoad[r.attr("src")]=!0,e=!0,this.loadRemoteString({url:r.attr("src")},_fsmCtsLoadSuccess,_fsmCtsLoadFail)):this.ingestRules(r.html())},this),e||this.fsmTransition("QueueingTrees")},_fsmQueueTrees:function(){console.log("FSM Queue Trees"),this.fsmTransition("LoadingTrees"),this._treesToLoad={};var e=!1;n.each(this.forrest.trees,function(e,t,n){console.log("TREE")},this),e||this.fsmTransition("Rendering")},_fsmRender:function(){console.log("FSM Render"),this.render(),this.fsmTransition("Rendered")},_fsmCtsLoadSuccess:function(e,t,n){this.ingestRules(e),this._fsmCtsLoaded(n.url)},_fsmCtsLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmTreeLoadSuccess:function(e,t,n){this._fsmCtsLoaded(n.url)},_fsmTreeLoadFail:function(e,t,n){this._fsmCtsLoaded(e.url)},_fsmCtsLoaded:function(e){delete this._ctsToLoad[e];var t=this._ctsToLoad.length===0;t&&_fsmTransition("QueueingTrees")},_fsmTreeLoaded:function(e){done&&_fsmTransition("Rendering")}}),t.Debugging={};var E=t.Debugging.TreeViz=function(e){this.forrest=e,this.init(),this.finish()};n.extend(E.prototype,{write:function(e){this.win.document.write(e)},init:function(){this.win=window.open("","CTS Tree Visualization","width=1000,height=800,scrollbars=1,resizable=1"),this.win.document.open(),this.write("<html><head>"),this.write('<script src="http://d3js.org/d3.v3.min.js"></script>'),this.write('<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>'),this.write('<script src="http://people.csail.mit.edu/eob/files/cts/extras/tree.js"></script>'),this.write('<link rel="stylesheet" href="http://people.csail.mit.edu/eob/files/cts/extras/tree.css"></script>'),this.writeTree(this.forrest.getPrimaryTree()),this.write('</head><body><div id="chart"></div>')},finish:function(){this.write("</body><html>"),this.win.document.close()},writeTree:function(e){this.write("<script>"),this.write("window.treeData = "),this.writeNode(e.root),this.write(";"),this.write("</script>")},writeNode:function(e){this.write("{"),this.write('name:"'+e.debugName()+'"');var t=e.getChildren();if(typeof t!="undefined"&&t.length>0){this.write(", children: [");for(var n=0;n<t.length;n++)this.writeNode(t[n]),n<t.length-1&&this.write(",");this.write("]")}this.write("}")}})}).call(this);